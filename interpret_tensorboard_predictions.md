# Интерпретация графиков Prediction в TensorBoard для GlowTTS

## Обзор

В TensorBoard для моделей синтеза речи (TTS) обычно отображаются несколько типов prediction графиков. Понимание этих графиков помогает диагностировать проблемы обучения и оценить качество модели.

---

## 1. Mel-Spectrogram Predictions (Мел-спектрограммы)

### Где найти:
- Вкладка **IMAGES** → секция `mel_spectrogram` или `prediction`

### Что показывают:
- **Target (целевая)**: Реальная мел-спектрограмма из обучающих данных
- **Predicted (предсказанная)**: Что модель генерирует

### Как интерпретировать:

#### ✅ ХОРОШО:
- Предсказанная спектрограмма **визуально похожа** на целевую
- Четкие **форманты** (горизонтальные полосы энергии) совпадают
- **Временная структура** совпадает (длительность звуков)
- **Энергия** распределена похожим образом

#### ❌ ПЛОХО:
- Предсказанная спектрограмма **полностью отличается** от целевой
- **Отсутствуют форманты** (только шум)
- **Неправильная длительность** (слишком короткая/длинная)
- **Постоянный шум** вместо структурированного звука
- **Пустые участки** там, где должны быть звуки

### Типичные проблемы:

1. **Только шум/гул**:
   - Модель не выучила соответствие текст-аудио
   - Возможные причины: неправильный sample_rate, плохие данные, недостаточно эпох

2. **Правильная структура, но смещена по времени**:
   - Проблемы с alignment (выравниванием)
   - Проверьте attention plots

3. **Правильная длительность, но неправильные форманты**:
   - Модель выучила timing, но не спектральные характеристики
   - Может потребоваться больше данных или эпох

---

## 2. Alignment/Attention Plots (Выравнивания)

### Где найти:
- Вкладка **IMAGES** → секция `alignment` или `attention`

### Что показывают:
- Соответствие между **символами текста** (по оси Y) и **временными шагами аудио** (по оси X)

### Как интерпретировать:

#### ✅ ХОРОШО:
- **Четкая диагональная линия** от левого нижнего угла к правому верхнему
- Линия **плавная**, без резких скачков
- **Один символ** → **несколько временных шагов** (нормально)
- Линия **непрерывная**, без разрывов

#### ❌ ПЛОХО:
- **Хаотичные паттерны** без структуры
- **Вертикальные полосы** (один символ растягивается на всё аудио)
- **Горизонтальные полосы** (один временной шаг соответствует всем символам)
- **Размытое/отсутствующее** выравнивание
- **Множественные пики** без четкой диагонали

### Типичные проблемы:

1. **Хаотичное выравнивание**:
   - Модель не выучила соответствие текст-аудио
   - **Решение**: больше эпох, проверка данных, уменьшение learning rate

2. **Вертикальные линии**:
   - Модель "застревает" на одном символе
   - **Решение**: проверить длительность аудио (не слишком ли длинные файлы)

3. **Горизонтальные линии**:
   - Модель не может различить символы
   - **Решение**: проверить словарь символов, убедиться что все символы в словаре

---

## 3. Duration Predictions (Предсказания длительности)

### Где найти:
- Вкладка **SCALARS** → `loss_dur` или `duration`
- Вкладка **IMAGES** → `duration_prediction`

### Что показывают:
- Сколько **временных шагов** модель предсказывает для каждого символа

### Как интерпретировать:

#### ✅ ХОРОШО:
- Предсказанные длительности **близки к реальным**
- График длительностей **плавный**, без резких скачков
- `loss_dur` **снижается** со временем обучения
- Длительности **реалистичные** (не 0, не бесконечные)

#### ❌ ПЛОХО:
- Предсказанные длительности **сильно отличаются** от реальных
- Все символы имеют **одинаковую длительность** (модель не выучила различия)
- Длительности **слишком короткие** (0-1 шаг) или **слишком длинные**
- `loss_dur` **не снижается** или **растет**

### Типичные проблемы:

1. **Постоянные длительности для всех символов**:
   - Модель не выучила различия между звуками
   - **Решение**: больше данных, проверка качества данных

2. **Слишком высокий loss_dur**:
   - Модель плохо предсказывает длительность
   - **Решение**: больше эпох, возможно уменьшить learning rate

---

## 4. Audio Waveform Predictions (Волновые формы)

### Где найти:
- Вкладка **AUDIO** (если доступна) или **IMAGES** → `waveform`

### Что показывают:
- Предсказанная **волновая форма** аудио сигнала

### Как интерпретировать:

#### ✅ ХОРОШО:
- Волновая форма имеет **четкую структуру** (не просто шум)
- **Амплитуда** варьируется естественным образом
- **Временная структура** соответствует тексту

#### ❌ ПЛОХО:
- **Постоянный шум** без структуры
- **Плоская линия** (нет звука)
- **Клиппинг** (сигнал обрезан на максимуме)

---

## 5. Loss Metrics (Метрики потерь)

### Где найти:
- Вкладка **SCALARS** → различные loss метрики

### Основные метрики:

#### `loss` (общий loss):
- **Должен снижаться** со временем
- Хорошие значения: < 0.5 после достаточного обучения
- **Может быть отрицательным!** Это нормально для GlowTTS
- Если не снижается → модель не обучается

**Важно:** В GlowTTS общий loss = `log_mle` + `loss_dur`. Поскольку `log_mle` (log-likelihood) может быть отрицательным, а `loss_dur` обычно положительный, общий loss может стать отрицательным, если `log_mle` достаточно отрицательный. Это **хороший знак** — означает, что модель хорошо выучила распределение данных.

#### `log_mle` (log maximum likelihood):
- Loss для предсказания мел-спектрограммы
- **Должен снижаться** и стать **отрицательным** (это нормально для log-likelihood)
- Хорошие значения: < 0.1 или отрицательные

#### `loss_dur` (loss длительности):
- Loss для предсказания длительности
- **Должен снижаться**
- Хорошие значения: < 0.5

### Как интерпретировать:

#### ✅ ХОРОШО:
- Все loss **стабильно снижаются**
- Loss **не колеблются** сильно между шагами
- Loss достигают **низких значений** (< 0.5)

#### ❌ ПЛОХО:
- Loss **не снижаются** или **растут**
- Сильные **колебания** loss (нестабильное обучение)
- Loss **застревают** на высоких значениях (> 1.0)

---

## 6. Градиенты (Gradients)

### Где найти:
- Вкладка **SCALARS** → `grad_norm`

### Как интерпретировать:

#### ✅ ХОРОШО:
- Градиенты **стабильные** (не слишком большие, не слишком маленькие)
- `grad_norm` в диапазоне **1-50**
- Градиенты **не взрываются** (не > 100)

#### ❌ ПЛОХО:
- **Взрыв градиентов** (grad_norm > 100):
  - **Решение**: уменьшить learning rate, использовать gradient clipping
  
- **Исчезновение градиентов** (grad_norm ≈ 0):
  - **Решение**: увеличить learning rate, проверить архитектуру

---

## Чек-лист диагностики проблем

### Если синтез дает только шум/гул:

1. ✅ Проверьте **alignment plots**:
   - Если хаотичные → модель не выучила соответствие
   - **Решение**: больше эпох, проверка данных

2. ✅ Проверьте **loss**:
   - Если loss > 1.0 → модель недообучена
   - **Решение**: больше эпох обучения

3. ✅ Проверьте **mel-spectrogram predictions**:
   - Если предсказания не похожи на target → модель не выучила спектральные характеристики
   - **Решение**: больше данных, проверка sample_rate

4. ✅ Проверьте **sample_rate**:
   - Должен совпадать в данных и конфиге (22050 Hz)
   - **Решение**: пересэмплировать данные или изменить конфиг

5. ✅ Проверьте **словарь символов**:
   - Все символы в тексте должны быть в словаре
   - **Решение**: обновить словарь, переобучить модель

### Если синтез работает, но качество плохое:

1. ✅ Проверьте **loss**:
   - Если loss > 0.5 → продолжите обучение
   
2. ✅ Проверьте **duration predictions**:
   - Если длительности неправильные → модель плохо выучила timing
   - **Решение**: больше эпох

3. ✅ Проверьте **mel-spectrogram predictions**:
   - Если форманты неправильные → модель плохо выучила спектральные характеристики
   - **Решение**: больше данных, возможно другой вокодер

---

## Рекомендации по улучшению

### Если alignment плохое:
- Увеличьте количество эпох
- Уменьшите learning rate (например, с 0.001 до 0.0005)
- Увеличьте warmup_steps в lr_scheduler
- Проверьте качество данных (sample_rate, длительность аудио)

### Если loss не снижается:
- Увеличьте количество эпох
- Проверьте, что данные загружаются правильно
- Уменьшите batch_size (может помочь стабильности)
- Проверьте градиенты (нет ли взрыва/исчезновения)

### Если mel-spectrograms плохие:
- Убедитесь, что sample_rate совпадает
- Проверьте качество аудио данных
- Увеличьте количество данных или эпох
- Рассмотрите использование вокодера вместо Griffin-Lim

---

## Полезные команды

### Запуск TensorBoard:
```bash
python view_tensorboard.py [путь_к_эксперименту]
```

### Просмотр конкретного эксперимента:
```bash
tensorboard --logdir=ruslan_glowtts_exp/run-December-08-2025_04+27PM-0000000
```

### Сравнение нескольких экспериментов:
```bash
tensorboard --logdir=ruslan_glowtts_exp
```

